<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.example.mapper.TaskMapper">

    <!-- 映射 -->
    <resultMap id="TaskMap" type="org.example.pojo.Tasks">
        <id property="id" column="id"/>
        <result property="userId" column="user_id"/>
        <result property="title" column="title"/>
        <result property="description" column="description"/>
        <result property="priority" column="priority"/>
        <result property="deadline" column="deadline"/>
        <result property="status" column="status"/>
        <result property="isDeleted" column="is_deleted"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <!-- 插入 -->
    <insert id="insert" parameterType="org.example.pojo.Tasks" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO tasks (user_id, title, description, priority, deadline, status, is_deleted, created_at, updated_at)
        VALUES (#{userId}, #{title}, #{description}, #{priority}, #{deadline}, #{status}, 0, NOW(), NOW())
    </insert>

    <!-- 更新（仅能更新自己的任务） -->
    <update id="update" parameterType="org.example.pojo.Tasks">
        UPDATE tasks
        <set>
            <if test="title ne null">title = #{title},</if>
            <if test="description ne null">description = #{description},</if>
            <if test="priority ne null">priority = #{priority},</if>
            <if test="deadline ne null">deadline = #{deadline},</if>
            <if test="status ne null">status = #{status},</if>
            updated_at = NOW()
        </set>
        WHERE id = #{id} AND user_id = #{userId} AND is_deleted = 0
    </update>

    <!-- 详情（只能看自己的） -->
    <select id="selectById" resultMap="TaskMap">
        SELECT * FROM tasks
        WHERE id = #{id} AND user_id = #{userId} AND is_deleted = 0
    </select>

    <!-- 软删除（只能删自己的） -->
    <update id="softDelete">
        UPDATE tasks SET is_deleted = 1, updated_at = NOW()
        WHERE id = #{id} AND user_id = #{userId} AND is_deleted = 0
    </update>

    <!-- 分页查询（只能查自己的） -->
    <select id="pageQuery" resultMap="TaskMap">
        SELECT * FROM tasks
        WHERE user_id = #{userId} AND is_deleted = 0
        <if test="q.status ne null">
            AND status = #{q.status}
        </if>
        <if test="q.priority ne null">
            AND priority = #{q.priority}
        </if>
        <if test="q.keyword ne null and q.keyword ne ''">
            AND (
            title LIKE CONCAT('%', #{q.keyword}, '%')
            OR description LIKE CONCAT('%', #{q.keyword}, '%')
            )
        </if>
        <choose>
            <when test="q.orderBy eq 'deadline_asc'">
                ORDER BY (deadline IS NULL) ASC, deadline ASC, id DESC
            </when>
            <when test="q.orderBy eq 'deadline_desc'">
                ORDER BY (deadline IS NULL) ASC, deadline DESC, id DESC
            </when>
            <otherwise>
                ORDER BY created_at DESC, id DESC
            </otherwise>
        </choose>
    </select>

    <!-- 更新状态（只能改自己的） -->
    <update id="updateStatus">
        UPDATE tasks SET status = #{status}, updated_at = NOW()
        WHERE id = #{id} AND user_id = #{userId} AND is_deleted = 0
    </update>

    <!-- 管理员查详情 -->
    <select id="selectByIdAdmin" resultMap="TaskMap">
        SELECT * FROM tasks
        WHERE id = #{id} AND is_deleted = 0
    </select>

    <!-- 管理员更新 -->
    <update id="updateByIdAdmin" parameterType="org.example.pojo.Tasks">
        UPDATE tasks
        <set>
            <if test="title ne null">title = #{title},</if>
            <if test="description ne null">description = #{description},</if>
            <if test="priority ne null">priority = #{priority},</if>
            <if test="deadline ne null">deadline = #{deadline},</if>
            <if test="status ne null">status = #{status},</if>
            updated_at = NOW()
        </set>
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <!-- 管理员软删除 -->
    <update id="softDeleteAdmin">
        UPDATE tasks SET is_deleted = 1, updated_at = NOW()
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <!-- 管理员分页 -->
    <select id="pageQueryAll" resultMap="TaskMap">
        SELECT * FROM tasks
        WHERE is_deleted = 0
        <if test="q.status ne null">
            AND status = #{q.status}
        </if>
        <if test="q.priority ne null">
            AND priority = #{q.priority}
        </if>
        <if test="q.keyword ne null and q.keyword ne ''">
            AND (
            title LIKE CONCAT('%', #{q.keyword}, '%')
            OR description LIKE CONCAT('%', #{q.keyword}, '%')
            )
        </if>
        <choose>
            <when test="q.orderBy eq 'deadline_asc'">
                ORDER BY (deadline IS NULL) ASC, deadline ASC, id DESC
            </when>
            <when test="q.orderBy eq 'deadline_desc'">
                ORDER BY (deadline IS NULL) ASC, deadline DESC, id DESC
            </when>
            <otherwise>
                ORDER BY created_at DESC, id DESC
            </otherwise>
        </choose>
    </select>

    <!-- 管理员改状态 -->
    <update id="updateStatusAdmin">
        UPDATE tasks SET status = #{status}, updated_at = NOW()
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <!-- 查找到期任务 -->
    <select id="findDueTasks" resultType="org.example.mapper.TaskMapper$DueTaskRow">
        SELECT
        t.user_id AS userId,
        u.email AS email,
        t.id AS taskId,
        t.title AS title,
        t.deadline AS deadline
        FROM tasks t
        JOIN users u ON u.id = t.user_id AND u.is_deleted = 0
        WHERE
        t.is_deleted = 0
        AND DATE(t.deadline) = #{date}
        <![CDATA[ AND t.status <> #{doneStatus} ]]>
    </select>

</mapper>
